<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Crime and day-of-week bar Charts</title>
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script src="http://d3js.org/d3.v3.js"></script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3LxJV9iIW3FzxhbccjNy9W1Trg-yBvBE&libraries=geometry"></script>
        <script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="js/polygon.min.js"></script>
    </head>

    <body>
        <!-- <div class="buttons" id="category">
            <button onclick="change('fraud')">Fraud</button>
            <button onclick="change('robbery')">Robbery</button>
            <button onclick="change('runaway')">Runaway</button>
            <button onclick="change('suicide')">Suicide</button>
        </div>
 -->
        <div id = "plot_canvas"></div>
        <script>
            var map,
                    start_date= new Date("2006-01"), end_date = new Date("2007-01"),
                    cleaned_data = [],
                    // months = d3.time.month.range(start_date, end_date, 1),
                    // area_coords = [{lat: 37.779933, lng: -122.487555}, 
                    //                 {lat: 37.782376, lng: -122.408591}, 
                    //                 {lat: 37.729852, lng: -122.401639},
                    //                 {lat: 37.726051, lng: -122.472535}],
                    // selected_area = new google.maps.Polygon({paths: area_coords}),
                    margin = { top: 20, right: 60, bottom: 20, left: 60 },
                    width = 640 + margin.left + margin.right,
                    height = 360 + margin.top + margin.bottom,
                    // dot_size = 2, dot_color = "#FFAD8F",
                    // valueline = d3.svg.line()
                    //             .x(function(d) { return x(new Date(d.date.getFullYear(), 0)); })
                    //             .y(function(d) { return y(d.num); });
                    // selected_category = "fraud",
                    category = {"fraud":"data/fraud.csv",
                            "runaway":"data/runaway.csv",
                            "burglary":"data/burglary.csv",
                            "suicide":"data/suicide.csv",
                            "kidnapping":"data/kidnapping.csv",
                            "prostitution":"data/prostitution.csv",
                            "assault":"data/assault.csv",
                            "gambling":"data/gambling.csv",
                            "trespass":"data/trespass.csv",
                            "robbery":"data/robbery.csv",
                            },
                    normlize = false,
                    color_book = d3.scale.ordinal()
    .range(["#FF6666","#FF9966","#FFCC33","#FFFF99","#CCFF99","#99CC66","#99CCCC","#0099FF","#CC99FF","#990099"]).domain(d3.keys(category));
                    // map = new google.maps.Map(document.getElementById('map'), {
                    //     zoom: 13,
                    //     center: {lat: 37.751843, lng: -122.446185},
                    //     mapTypeId: google.maps.MapTypeId.SATELLITE
                    // });

                    // heatmap = new google.maps.visualization.HeatmapLayer({
                    //     map: map
                    // });

                // // **********polygon creator************
                // var creator = new PolygonCreator(map);
                // // **********polygon creator************

                // google.maps.event.addListener(map, 'click', function(event) {
                //     console.log(area_coords);

                //      // *********reset button*************
                //     $('#reset').click(function(){ 
                //         creator.destroy();
                //         creator=null;                
                //         creator=new PolygonCreator(map);
                //         area_coords = [];
                //     });
                //     //**************************//
                //     if (area_coords.length == 4) {
                //         area_coords = [];} 
                //     area_coords.push(event.latLng);
                //     if (area_coords.length == 4) {
                //         selected_area = new google.maps.Polygon({paths: area_coords});
                //         set_data();
                //     };
                //     console.log(area_coords);
                // });

                // Set the ranges
                // var x = d3.time.scale().range([0, width - margin.right - margin.left - 5]).domain([start_date, end_date]),
                var x = d3.scale.linear().range([0, width - margin.right - margin.left - 5]).domain([0,8]),
                    y = d3.scale.linear().range([height - margin.bottom - margin.top, 0]).domain([0,1]),
                    // Define the axes
                    // xAxis = d3.svg.axis().scale(x).ticks(d3.time.month, 3).tickFormat(d3.time.format("%y")).orient("bottom"),
                    xAxis = d3.svg.axis().scale(x).ticks(7).orient("bottom"),
                    yAxis = d3.svg.axis().scale(y).tickFormat(d3.format('.0f')).orient("left").ticks(10);

                // set up all svg
                        svg_plot_canvas = d3.select("#plot_canvas").append("svg")
                                            .attr("width", width)
                                            .attr("height", height)
                                            .append("g")
                                            .attr("transform", "translate(" + margin.left + ',' + margin.top +")");

                        // svg_plot_canvas.append("text").text(key).attr("x", (width - margin.right - margin.left) / 2).attr("y", 0).attr("text-anchor", "middle");
                        svg_plot_canvas.append("g")
                            .attr("transform", "translate(0," + (height - margin.bottom - margin.top) +")")
                            .attr("class", "axis")
                            .attr("id", "xAxis")
                            .call(xAxis);

                        svg_plot_canvas.append("g")
                            .attr("class", "axis")
                            .attr("id", "yAxis")
                            .call(yAxis);

                    var legend = svg_plot_canvas.selectAll(".legend")
      .data(Object.keys(category))
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(0," + i * margin.right/3 + ")"; });

  legend.append("rect")
      .attr("x", width - margin.right * 2.5)
      .attr("width", margin.right / 2)
      .attr("height", margin.right / 3)
      .style("fill", function(d) {return color_book(d)});

  legend.append("text")
      .attr("x", width - margin.right * 2)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "start")
      .text(function(d) { return d; });

                // var area = d3.svg.area()
                //             .x(function(d) { return x(d.date); })
                //             .y0(function(d) { return y(d.y0); })
                //             .y1(function(d) { return y(d.y0 + d.y); }),
                var stack = d3.layout.stack()
                                        .values(function(d) {return d.values;})
                                        .x(function(d) { return x(d.dayofweek); })
                                        .y(function(d) { return d.num; });

                function set_data() {
                    for (var key in category) {
                        if (category.hasOwnProperty(key)) {
                            set_data_onetype(key);
                        }
                    }

                }

                function set_data_onetype(selected_category) {
                    d3.csv(category[selected_category], 
                    function(d) {
                        // if (google.maps.geometry.poly.containsLocation(new google.maps.LatLng(Number(d.Y), Number(d.X)), selected_area)) {
                        //     return [{date:new Date(d.Dates), num :1}]
                        // };
                        date = new Date(d.Dates);
                        if (date > start_date && date < end_date) {
                            return [{dayofweek:date.getDay(), num : 1}]
                        }; 
                    }, 
                    function(error, data) {
                        if (error != null) {
                            console.log(error); 
                            return};

                        for (var i = 0; i < 7; i++) {
                            data.push([{dayofweek: i, num :0}]);
                        };

                        data.sort(function(a, b){
                                    // Compare the 2 dates
                                    if(a[0].dayofweek < b[0].dayofweek) return -1;
                                    if(a[0].dayofweek > b[0].dayofweek) return 1;
                                    return 0;
                                });

                        // data = data.reduce(function (a, b) {
                        //     if (a[a.length-1].date.getFullYear() == b[b.length-1].date.getFullYear() && a[a.length-1].date.getMonth() == b[b.length-1].date.getMonth()) {
                        //         a[a.length-1].num += b[b.length-1].num;
                        //         return a;
                        //     } else{
                        //         return a.concat(b);
                        //     };
                        // });

                        data = data.reduce(function (a, b) {
                            if (a[a.length-1].dayofweek == b[b.length-1].dayofweek) {
                                a[a.length-1].num += b[b.length-1].num;
                                return a;
                            } else{
                                return a.concat(b);
                            };
                        });

                        var new_data = {type: selected_category, values: data}

                        if (cleaned_data.length == Object.keys(category).length) {
                            cleaned_data = [];} 
                        cleaned_data.push(new_data);
                        if (cleaned_data.length == Object.keys(category).length) {
                            plot_dayofweek_graph();
                        };
                        console.log(cleaned_data);

                        // update the y axis
            //          var max_y = d3.max(data, function(d) { return d.num; });
                        // y.domain([0, max_y]);
                        // yAxis.scale(y);
                        // svg_plot_canvas.select("#yAxis").call(yAxis);

            //          // console.log(data)
            //             // Add the valueline path.
            //             line = svg_plot_canvas.selectAll("path.line").data([data])
            //                             .attr("class", "line")
            //                             .attr("d", valueline(data));
            //             line.enter()
            //                 .append("path")
            //                 .attr("class", "line")
            //                 .attr("d", valueline(data));
            //          dots = svg_plot_canvas.selectAll(".dot").data(data, function(d,i) {return d.num + "-" + d.date.getFullYear();});
                        // dots.exit().remove();
                        // dots.enter()
                        //  .append("circle")
                        //  .attr("class", "dot")
                        //  .attr("id", selected_category)
                        //  .attr("cx", function(d, i) { return x(new Date(d.date.getFullYear(),0));})
                        //  .attr("cy", function(d) { return y(d.num);})
                        //  .attr("r", dot_size)
                        //  .attr("fill", dot_color);
                    }
                    );
                }


                function plot_dayofweek_graph () {
                    stack_data = stack(cleaned_data);
                    
                    if (normlize) {
                        for (var i = 0; i <= stack_data.length - 1; i++) {
                        for (var j = 0; j <= stack_data[i].values.length - 1; j++) {
                            norm = stack_data[stack_data.length-1].values[j].y + stack_data[stack_data.length-1].values[j].y0
                            stack_data[i].values[j].y = stack_data[i].values[j].y / norm
                            stack_data[i].values[j].y0 = stack_data[i].values[j].y0 / norm
                        };
                    };
                    };

                    //   update the y axis
                     var max_y = d3.max(stack_data[stack_data.length-1].values, function(d) { return d.y + d.y0; });
                        y.domain([0, max_y]);
                        yAxis.scale(y);
                        svg_plot_canvas.select("#yAxis").call(yAxis);

                    var layers = svg_plot_canvas.selectAll(".layer").data(stack_data, function(d,i){ return i + '-' + d.values[0].y0 + '-' + d.values[0].y; });
                    layers.exit().remove();
                    var new_layers = layers.enter().append("g").attr("class", "layer").style("fill", function(d) { return color_book(d.type); });
                    new_layers.selectAll("rect")
      .data(function(d) { return d.values; })
    .enter().append("rect")
      .attr("x", function(d) { return x(d.dayofweek + 1) - 25; })
      .attr("y", function(d) { return y(d.y + d.y0); })
      .attr("height", function(d) { return y(d.y0) - y(d.y + d.y0); })
      .attr("width", 50);
                    // append("rect")
                    //         .attr("d", function(d) { return area(d.values); })
                    //         .style("fill", function(d, i) { return color_book(d.type); });
                    // new_layers.append("text")
                    //         .text(function(d) {return d.type;})
                    //         .attr("text-anchor", "start")
                    //         .attr("x", width - margin.right - margin.left)
                    //         .attr("y", function(d, i) {console.log(d.values[d.values.length - 1].y0);return y(d.values[d.values.length - 3].y0 + i * 10); });


                     
                }

                set_data();
        </script>
    </body>
</html>